name: The Titan Protocol (v21.0 - Consensus Build)

on:
  workflow_dispatch:
    inputs:
      idea:
        description: 'App Idea (e.g., A video editor like CapCut)'
        required: true

permissions:
  contents: write
  actions: write

jobs:
  symbiosis:
    runs-on: macos-latest

    steps:
      - name: '1. Checkout'
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: '2. Config Git'
        run: |
          git config --global user.name "Titan-Forge"
          git config --global user.email "titan@ai.com"
          git remote set-url origin https://x-access-token:${{ secrets.MASTER_KEY }}@github.com/${{ github.repository }}

      - name: '3. Setup Java 17'
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: '4. Clean Workspace'
        run: |
          find . -maxdepth 1 ! -name '.git' ! -name '.' -exec rm -rf {} +

      - name: '5. The Titan Council (Architectural Generation)'
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }} 
          GROQ_KEY: ${{ secrets.GROQ_KEY }}
          USER_PROMPT: ${{ github.event.inputs.idea }}
        run: |
          pip3 install requests --break-system-packages
          python3 - <<'EOF'
          import os, requests, concurrent.futures, re, json

          def call_model(model_id, prompt, role):
              g_key = os.getenv('GEMINI_API_KEY')
              q_key = os.getenv('GROQ_KEY')
              try:
                  if 'gemini' in model_id:
                      # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø³ØªÙ‚Ø± Ù„ØªØ¬Ù†Ø¨ Ø®Ø·Ø£ 404
                      url = f"https://generativelanguage.googleapis.com/v1/models/{model_id}:generateContent?key={g_key}"
                      data = {"contents": [{"parts": [{"text": f"{role}\n\n{prompt}"}]}]}
                      res = requests.post(url, json=data, timeout=180)
                  else:
                      url = "https://api.groq.com/openai/v1/chat/completions"
                      headers = {"Authorization": f"Bearer {q_key}"}
                      data = {"model": model_id, "messages": [{"role": "system", "content": role}, {"role": "user", "content": prompt}]}
                      res = requests.post(url, json=data, timeout=180)
                  res.raise_for_status()
                  return res.json()['candidates'][0]['content']['parts'][0]['text'] if 'gemini' in model_id else res.json()['choices'][0]['message']['content']
              except Exception as e:
                  print(f"Model {model_id} failed: {e}")
                  return ""

          idea = os.getenv('USER_PROMPT')
          
          # Ø§Ù„Ù…Ø±Ø­Ù„Ø© 5.1: Ø§Ù„ØªØ®Ø·ÙŠØ· Ø§Ù„Ù…Ø¹Ù…Ø§Ø±ÙŠ Ù„Ù„Ù…Ø´Ø±ÙˆØ¹
          arch_prompt = f"Design a complete Android project for '{idea}'. Output ONLY a raw JSON object where keys are file paths and values are code descriptions. Include app/build.gradle, AndroidManifest.xml, and Java files."
          
          # Ø§Ø³ØªØ´Ø§Ø±Ø© Manus Ùˆ Groq Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù‡ÙŠÙƒÙ„
          arch_plan = call_model("llama-3.3-70b-versatile", arch_prompt, "Senior Android Architect")
          
          try:
              json_match = re.search(r'\{.*\}', arch_plan, re.DOTALL)
              file_structure = json.loads(json_match.group(0))
          except Exception:
              # Fallback: Ù‡ÙŠÙƒÙ„ Ø·ÙˆØ§Ø±Ø¦ Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„Ù€ JSON
              file_structure = {
                  "app/build.gradle": "Basic dependencies",
                  "app/src/main/AndroidManifest.xml": "Main Manifest",
                  "app/src/main/java/com/titan/forge/MainActivity.java": "Primary Entry Point"
              }

          # Ø§Ù„Ù…Ø±Ø­Ù„Ø© 5.2: ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø¨Ø§Ù„ØªØ²Ø§Ù…Ù†
          def generate_file(path, desc):
              code_prompt = f"Write the raw source code for '{path}'. Content: {desc}. NO Markdown."
              # Gemini ÙŠÙ‚ÙˆÙ… Ø¨Ø¯ÙˆØ± Ø§Ù„Ù‚Ø§Ø¶ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ø¶Ù…Ø§Ù† Ø¯Ù‚Ø© Ø§Ù„ÙƒÙˆØ¯
              code = call_model("gemini-1.5-flash", code_prompt, "Production Java Developer")
              clean_code = re.sub(r"```[a-z]*\n|```", "", code).strip()
              os.makedirs(os.path.dirname(path), exist_ok=True)
              with open(path, "w") as f:
                  f.write(clean_code)
              return path

          with concurrent.futures.ThreadPoolExecutor(max_workers=5) as executor:
              list(executor.map(lambda p: generate_file(p[0], p[1]), file_structure.items()))
          EOF

      - name: '6. Finalize Project Structure'
        run: |
          # Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù€ Wrapper Ù‚Ø³Ø±Ø§Ù‹ Ù„Ø¶Ù…Ø§Ù† Ø¹Ù…Ù„ Gradle
          gradle wrapper --gradle-version 8.5
          
          # Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ø§Ù„ØªÙŠ Ù‚Ø¯ ÙŠÙ†Ø³Ø§Ù‡Ø§ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
          if [ ! -f "settings.gradle" ]; then echo "include ':app'" > settings.gradle; fi
          if [ ! -f "gradle.properties" ]; then echo "android.useAndroidX=true" > gradle.properties; fi

      - name: '7. Build The Titan'
        run: |
          chmod +x gradlew
          ./gradlew assembleDebug --stacktrace

      - name: '8. Deliver The Titan'
        if: success()
        run: |
          git add .
          git commit -m "ðŸš€ TITAN FORGED: ${{ github.event.inputs.idea }}"
          git push --force
      
      - uses: actions/upload-artifact@v4
        with:
          name: Titan-APK
          path: app/build/outputs/apk/debug/*.apk
