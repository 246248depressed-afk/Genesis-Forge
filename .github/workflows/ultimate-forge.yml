name: ๐ THE FORGE ULTIMATE - Auto Self-Improvement Pro MAX v2.5

on:
  schedule:
    - cron: '0 */3 * * *'
  
  workflow_dispatch:
    inputs:
      improvement_focus:
        description: 'ูุฌุงู ุงูุชุญุณูู ุงููุทููุจ'
        required: false
        default: 'all'
        type: choice
        options:
          - 'all'
          - 'code_quality'
          - 'performance'
          - 'error_handling'
          - 'documentation'
          - 'security'
      force_improvement:
        description: 'ูุฑุถ ุงูุชุญุณูู ุญุชู ูู ูุงู ุงููุธุงู ูุดุบููุงู'
        required: false
        type: boolean
        default: false

concurrency:
  group: forge-self-improvement-pro-max
  cancel-in-progress: true

permissions:
  contents: write
  actions: write
  checks: write
  issues: write
  pull-requests: write

env:
  IMPROVEMENT_CYCLE_MINUTES: 180
  MAX_IMPROVEMENT_TIME: 45
  SYSTEM_STATUS_FILE: '.forge/system_status.json'

jobs:
  check-system-availability:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      can_improve: ${{ steps.check_improvement.outputs.can_improve }}
    
    steps:
      - name: ๐ ูุญุต ุญุงูุฉ ุงููุธุงู ุงูุฐูู
        id: check_busy
        run: |
          echo "========================================"
          echo "   ๐ค THE FORGE ULTIMATE - System Scan"
          echo "========================================"
          ACTIVE_RUNS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs?status=in_progress&per_page=5" | \
            jq '.workflow_runs | length' || echo "0")
          
          SYSTEM_LOAD=$((ACTIVE_RUNS - 1))
          if [ "$SYSTEM_LOAD" -gt 2 ]; then
            echo "๐จ ุงููุธุงู ูุดุบูู ุฌุฏุงู ($SYSTEM_LOAD ุนูููุงุช ูุดุทุฉ)"
            echo "busy=true" >> $GITHUB_OUTPUT
          else
            echo "โ ุงููุธุงู ุบูุฑ ูุดุบูู"
            echo "busy=false" >> $GITHUB_OUTPUT
          fi
      
      - name: ๐ ูุญุต ุขุฎุฑ ุนูููุฉ ุชุญุณูู ุฐููุฉ
        id: check_last_improvement
        run: |
          echo "๐ ูุญุต ุชุงุฑูุฎ ุงูุชุญุณููุงุช..."
          WORKFLOW_FILE_NAME=$(basename "${{ github.workflow_ref }}")
          LAST_SUCCESS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/actions/workflows/${WORKFLOW_FILE_NAME}/runs?event=schedule&status=success&per_page=1" | \
            jq -r '.workflow_runs[0].created_at // "2024-01-01T00:00:00Z"')
          echo "last_time=$LAST_SUCCESS" >> $GITHUB_OUTPUT
          echo "๐ ุขุฎุฑ ุชุญุณูู ูุงุฌุญ: $LAST_SUCCESS"
      
      - name: โ๏ธ ุชูููู ุฐูู ูุฅููุงููุฉ ุงูุชุญุณูู
        id: check_improvement
        run: |
          echo "โ๏ธ ุชูููู ุฐูู..."
          IS_MANUAL_RUN=${{ github.event_name == 'workflow_dispatch' }}
          FORCE_IMPROVEMENT=${{ github.event.inputs.force_improvement || 'false' }}

          if [ "$IS_MANUAL_RUN" = "true" ] && [ "$FORCE_IMPROVEMENT" = "true" ]; then
            echo "๐ ุชุญุณูู ุฅุฌุจุงุฑู ููุนูู"
            echo "can_improve=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          if [ "${{ steps.check_busy.outputs.busy }}" = "true" ]; then
            echo "โธ๏ธ ุงููุธุงู ูุดุบูู - ุงูุชุธุงุฑ"
            echo "can_improve=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          LAST_TIME="${{ steps.check_last_improvement.outputs.last_time }}"
          LAST_TIMESTAMP=$(date -d "$LAST_TIME" +%s 2>/dev/null || echo 0)
          NOW_TIMESTAMP=$(date +%s)
          MINUTES_SINCE=$(( (NOW_TIMESTAMP - LAST_TIMESTAMP) / 60 ))

          if [ "$MINUTES_SINCE" -lt 170 ]; then
            echo "โณ ููุช ุบูุฑ ูุงูู ููุฐ ุขุฎุฑ ุชุญุณูู ($MINUTES_SINCE ุฏูููุฉ)"
            echo "can_improve=false" >> $GITHUB_OUTPUT
          else
            echo "โ ุธุฑูู ูุซุงููุฉ ููุชุญุณูู"
            echo "can_improve=true" >> $GITHUB_OUTPUT
          fi

  self-improvement-cycle:
    runs-on: ubuntu-latest
    needs: check-system-availability
    if: needs.check-system-availability.outputs.can_improve == 'true'
    timeout-minutes: ${{ env.MAX_IMPROVEMENT_TIME }}
    
    steps:
      - name: ๐ฅ ุฌูุจ ุงูููุฏ ูุน ุตูุงุญูุงุช ูุงููุฉ
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: ๐ฆ ุชุซุจูุช ุฃุฏูุงุช ูุชูุฏูุฉ
        run: |
          echo "๐ง ุชุซุจูุช ุฃุฏูุงุช THE FORGE PRO..."
          sudo apt-get update && sudo apt-get install -y \
            tree jq curl wget unzip python3 python3-pip yamllint cloc || echo "โ๏ธ ุจุนุถ ุงูุฃุฏูุงุช ูู ุชูุซุจุช"
          pip3 install --upgrade pip requests pyyaml || true
          echo "โ ุงูุฃุฏูุงุช ุฌุงูุฒุฉ"
      
      - name: ๐ ุชุญููู ุงููุธุงู ุงูุนููู
        id: deep_analysis
        run: |
          echo "๐ง ุจุฏุก ุงูุชุญููู ุงูุนููู..."
          mkdir -p .forge/analysis
          
          # ุชุญููู ุงูููุฏ ุจุญุซุงู ุนู ููุงุท ุถุนู
          grep -r -n -i -E "TODO|FIXME|HACK|deprecated" --exclude-dir={.git,.github} . 2>/dev/null | head -20 > .forge/analysis/code_analysis.txt || true
          
          # ุชุญููู ูููุงุช YAML
          find . -name "*.yml" -o -name "*.yaml" | while read file; do
            yamllint "$file" >> .forge/analysis/yaml_lint.txt 2>&1 || true
          done
          
          echo "โ ุชู ุชุญููู ุงููุธุงู ุจูุฌุงุญ"
      
      - name: ๐ง ุชุญุฏูุฏ ูุฌุงูุงุช ุงูุชุญุณูู ุจุงูุฐูุงุก ุงูุงุตุทูุงุนู
        id: identify_improvements
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          IMPROVEMENT_FOCUS: ${{ github.event.inputs.improvement_focus || 'all' }}
        run: |
          echo "๐ง ุชุญุฏูุฏ ูุฌุงูุงุช ุงูุชุญุณูู..."
          ANALYSIS_DATA=$(cat .forge/analysis/code_analysis.txt 2>/dev/null || echo "ูุง ุชูุฌุฏ ุจูุงูุงุช")
          
          if [ -n "$DEEPSEEK_API_KEY" ]; then
            # ุฅูุดุงุก ุงูุจุฑููุจุช
            PROMPT="ุชุญููู ุงูููุฏ:\n${ANALYSIS_DATA}\n\nูุฌุงู ุงูุชุญุณูู ุงููุทููุจ: ${IMPROVEMENT_FOCUS}\n\nุงูุชุฑุญ 3-5 ุชุญุณููุงุช ุนูููุฉ ููุญุฏุฏุฉ ููููุงุช GitHub Actions YML ูุน ุฃูุซูุฉ ููุฏ."
            
            # ุฅูุดุงุก JSON payload
            JSON_PAYLOAD=$(jq -n --arg prompt "$PROMPT" '{
              "model": "deepseek-chat",
              "messages": [
                {"role": "system", "content": "ุฃูุช ุฎุจูุฑ ุชุญุณูู ุฃูุธูุฉ GitHub Actions. ูุฏู ูุตุงุฆุญ ุนูููุฉ."},
                {"role": "user", "content": $prompt}
              ],
              "temperature": 0.3,
              "max_tokens": 2000
            }')

            IMPROVEMENT_SUGGESTIONS=$(curl -s -X POST "https://api.deepseek.com/v1/chat/completions" \
              -H "Authorization: Bearer $DEEPSEEK_API_KEY" \
              -H "Content-Type: application/json" \
              -d "$JSON_PAYLOAD" | jq -r '.choices[0].message.content')
            
            echo "$IMPROVEMENT_SUGGESTIONS" > .forge/analysis/improvement_suggestions.md
          else
            echo "# ุงูุชุฑุงุญุงุช ุงูุชุญุณูู ุงูุงูุชุฑุงุถูุฉ\n- ุชุญุณูู ุฌูุฏุฉ ุงูููุฏ\n- ุชุญุณูู ุงูุฃุฏุงุก" > .forge/analysis/improvement_suggestions.md
          fi
          echo "โ ุชู ุชุญุฏูุฏ ูุฌุงูุงุช ุงูุชุญุณูู"
      
      - name: ๐ง ุชุทุจูู ุงูุชุญุณููุงุช ุงูุฐุงุชูุฉ
        run: |
          echo "๐ง ุชุทุจูู ุงูุชุญุณููุงุช ุงูุฐุงุชูุฉ..."
          
          # 1. ุชุญุณูู ุฌูุฏุฉ ุงูููุฏ (ุฅุถุงูุฉ ุชุนูููุงุช)
          find . -name "*.yml" -o -name "*.yaml" | while read file; do
            if ! grep -q "# ๐ Auto-Improved by THE FORGE" "$file"; then
              sed -i '1s/^/# ๐ Auto-Improved by THE FORGE\n\n/' "$file"
            fi
          done
          
          # 2. ุชุญุณูู ุงูุฃุฏุงุก (ุฅุถุงูุฉ timeout)
          find . -name "*.yml" -o -name "*.yaml" | while read file; do
            if grep -q "runs-on:" "$file" && ! grep -q "timeout-minutes:" "$file"; then
              sed -i '/runs-on:/a \ \ \ \ timeout-minutes: 60' "$file"
            fi
          done
          
          echo "โ ุชู ุชุทุจูู ุงูุชุญุณููุงุช ุจูุฌุงุญ"
      
      - name: ๐ ุชุญุฏูุซ ุงูุชูุซูู ูุณุฌู ุงูุชุบููุฑุงุช
        run: |
          echo "๐ ุชุญุฏูุซ ุงูุชูุซูู..."
          mkdir -p .forge
          echo "## ๐ง ุชุญุณูู ุฐุงุชู - $(date -u +'%Y-%m-%dT%H:%M:%SZ')\n- โ ุชุญุณูู ุฌูุฏุฉ ุงูููุฏ\n- โก ุชุญุณูู ุงูุฃุฏุงุก\n---" >> .forge/improvement_log.md
          echo "โ ุชู ุชุญุฏูุซ ุงูุชูุซูู"
      
      - name: ๐พ ุญูุธ ุงูุชุบููุฑุงุช ูุฑูุนูุง
        run: |
          echo "๐ค ุฑูุน ุงูุชุบููุฑุงุช ุฅูู ุงููุณุชูุฏุน..."
          git config --global user.email "forge-auto-improvement@system.com"
          git config --global user.name "THE FORGE Auto-Improvement"
          
          git add .
          
          if ! git diff --staged --quiet; then
            COMMIT_MSG="๐ง ุชุญุณูู ุฐุงุชู ุชููุงุฆู - $(date +'%Y-%m-%d %H:%M')

            ุงูุชุบููุฑุงุช ุงูุชููุงุฆูุฉ:
            - ุชุญุณูู ุฌูุฏุฉ ุงูููุฏ ุจุฅุถุงูุฉ ุชุนูููุงุช
            - ุชุญุณูู ุงูุฃุฏุงุก ุจุฅุถุงูุฉ timeout
            - ุชุญุฏูุซ ุณุฌู ุงูุชุญุณููุงุช"
            
            git commit -m "$COMMIT_MSG"
            git push origin HEAD:${{ github.ref }}
            echo "โ ุชู ุฑูุน ุงูุชุบููุฑุงุช ุจูุฌุงุญ"
          else
            echo "โน๏ธ ูุง ุชูุฌุฏ ุชุบููุฑุงุช ุฌุฏูุฏุฉ ูุฑูุนูุง."
          fi
      
      - name: ๐จ ุฅุดุนุงุฑ ุจูุฌุงุญ ุงูุชุญุณูู
        if: success()
        run: |
          echo "๐จ ุฅุฑุณุงู ุฅุดุนุงุฑ ุจูุฌุงุญ ุงูุชุญุณูู..."
          
          # ุฅูุดุงุก Issue ูู GitHub ูุฅุนูุงูู ุจุงูุชุญุณูู
          JSON_PAYLOAD=$(jq -n --arg date "$(date +'%Y-%m-%d %H:%M')" '{
            "title": "โ ุชุญุณูู ุฐุงุชู ุชููุงุฆู ูุงุฌุญ - \($date)",
            "body": "ูุงู ุงููุธุงู ุจุชุญุณูู ููุณู ุชููุงุฆูุงู.\n\n**ุงูุชุบููุฑุงุช:**\n- ุชุญุณูู ุฌูุฏุฉ ุงูููุฏ\n- ุชุญุณูู ุงูุฃุฏุงุก\n\n**ุงูุชุญุณูู ุงููุงุฏู:** ุจุนุฏ 3 ุณุงุนุงุช ุชูุฑูุจุงู.",
            "labels": ["auto-improvement", "enhancement"]
          }')

          curl -s -X POST -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/issues" \
            -d "$JSON_PAYLOAD" || echo "โ๏ธ ูุดู ูู ุฅูุดุงุก Issue"
          
          echo "โ ุชู ุฅุฑุณุงู ุงูุฅุดุนุงุฑ"
