name: Ultimate Forge

on:
  workflow_dispatch:
    inputs:
      app_idea:
        description: 'ÙˆØµÙ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨'
        required: true
        default: 'ØªØ·Ø¨ÙŠÙ‚ Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯ Ù…ØªÙƒØ§Ù…Ù„'
      app_name:
        description: 'Ø§Ø³Ù… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚'
        required: true
        default: 'MyAIApp'
      package_name:
        description: 'Ø§Ø³Ù… Ø§Ù„Ø­Ø²Ù…Ø©'
        required: true
        default: 'com.ai.forge.app'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
        uses: actions/checkout@v4
      
      - name: â˜• Ø¥Ø¹Ø¯Ø§Ø¯ Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: ğŸ¤– ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ÙƒÙˆØ¯ Ù…Ø¹ DeepSeek
        id: generate_code
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          APP_IDEA: ${{ github.event.inputs.app_idea }}
          APP_NAME: ${{ github.event.inputs.app_name }}
          PACKAGE_NAME: ${{ github.event.inputs.package_name }}
        run: |
          pip3 install requests
          python3 << 'EOF'
          import os, requests, re, json
          
          api_key = os.getenv('DEEPSEEK_API_KEY')
          idea = os.getenv('APP_IDEA')
          app_name = os.getenv('APP_NAME')
          package_name = os.getenv('PACKAGE_NAME')
          
          if not api_key:
              print("âŒ DEEPSEEK_API_KEY ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯")
              exit(1)
          
          print("ğŸš€ Ø¨Ø¯Ø¡ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚...")
          
          url = "https://api.deepseek.com/chat/completions"
          headers = {
              "Authorization": f"Bearer {api_key}",
              "Content-Type": "application/json"
          }
          
          prompt = f"""
          Ø£Ù†Ø´Ø¦ ØªØ·Ø¨ÙŠÙ‚ Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯ ÙƒØ§Ù…Ù„ Ù…Ø¹:
          
          Ø§Ø³Ù… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚: {app_name}
          ÙÙƒØ±Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚: {idea}
          Ø§Ø³Ù… Ø§Ù„Ø­Ø²Ù…Ø©: {package_name}
          
          Ø£Ø¹Ø¯ Ø§Ù„ÙƒÙˆØ¯ Ø¨ØµÙŠØºØ©:
          
          ### FILE: settings.gradle
          Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù„Ù
          ### ENDFILE
          
          ### FILE: build.gradle
          Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù„Ù
          ### ENDFILE
          
          ### FILE: app/build.gradle
          Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù„Ù
          ### ENDFILE
          
          ### FILE: app/src/main/AndroidManifest.xml
          Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù„Ù
          ### ENDFILE
          
          ### FILE: app/src/main/java/{package_name.replace('.', '/')}/MainActivity.kt
          Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù„Ù
          ### ENDFILE
          
          ### FILE: app/src/main/res/values/themes.xml
          Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù„Ù
          ### ENDFILE
          
          ### FILE: app/src/main/res/values/colors.xml
          Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù„Ù
          ### ENDFILE
          
          ### FILE: app/src/main/res/values/strings.xml
          Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù„Ù
          ### ENDFILE
          """
          
          payload = {
              "model": "deepseek-chat",
              "messages": [
                  {
                      "role": "system",
                      "content": "Ø£Ù†Øª Ù…Ø·ÙˆØ± Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯ Ù…Ø­ØªØ±Ù."
                  },
                  {
                      "role": "user",
                      "content": prompt
                  }
              ],
              "temperature": 0.3,
              "max_tokens": 6000
          }
          
          try:
              response = requests.post(url, json=payload, headers=headers, timeout=60)
              
              if response.status_code == 200:
                  data = response.json()
                  content = data['choices'][0]['message']['content']
                  
                  # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…Ù„ÙØ§Øª
                  files = []
                  pattern = r'### FILE:\s*(.+?)\n(.*?)### ENDFILE'
                  matches = re.findall(pattern, content, re.DOTALL)
                  
                  for filename, file_content in matches:
                      filename = filename.strip()
                      file_content = file_content.strip()
                      files.append((filename, file_content))
                  
                  print(f"âœ… ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… {len(files)} Ù…Ù„Ù")
                  
                  # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù„ÙØ§Øª
                  for filename, file_content in files:
                      # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª
                      os.makedirs(os.path.dirname(filename), exist_ok=True)
                      
                      # Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù
                      with open(filename, 'w', encoding='utf-8') as f:
                          f.write(file_content)
                      
                      print(f"ğŸ“„ {filename}")
                  
                  # Ø­ÙØ¸ Ø§Ù„Ø±Ø¯
                  with open('ai_response.txt', 'w', encoding='utf-8') as f:
                      f.write(content)
                  
                  print(f"files_count={len(files)}" >> $GITHUB_OUTPUT)
                  
              else:
                  print(f"âŒ Ø®Ø·Ø£: {response.status_code}")
                  print(response.text)
                  exit(1)
                  
          except Exception as e:
              print(f"âŒ Ø§Ø³ØªØ«Ù†Ø§Ø¡: {str(e)}")
              exit(1)
          EOF
      
      - name: ğŸ“ Ø¥Ù†Ø´Ø§Ø¡ Ù‡ÙŠÙƒÙ„ Ø§Ø­ØªÙŠØ§Ø·ÙŠ
        if: steps.generate_code.outputs.files_count < 3
        run: |
          echo "ğŸ”¨ Ø¥Ù†Ø´Ø§Ø¡ Ù‡ÙŠÙƒÙ„ Ø§Ø­ØªÙŠØ§Ø·ÙŠ..."
          
          # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª
          mkdir -p app/src/main/res/values
          mkdir -p app/src/main/res/drawable
          
          # Ø¥Ù†Ø´Ø§Ø¡ package folder
          PACKAGE_PATH=$(echo '${{ github.event.inputs.package_name }}' | sed 's/\./\//g')
          mkdir -p "app/src/main/java/$PACKAGE_PATH"
          mkdir -p "app/src/main/kotlin/$PACKAGE_PATH"
          
          # settings.gradle
          cat > settings.gradle << 'EOF'
          pluginManagement {
              repositories {
                  google()
                  mavenCentral()
                  gradlePluginPortal()
              }
          }
          dependencyResolutionManagement {
              repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
              repositories {
                  google()
                  mavenCentral()
              }
          }
          
          rootProject.name = "MyApp"
          include ':app'
          EOF
          
          # build.gradle (root)
          cat > build.gradle << 'EOF'
          plugins {
              id 'com.android.application' version '8.2.0' apply false
              id 'org.jetbrains.kotlin.android' version '1.9.22' apply false
          }
          EOF
          
          # app/build.gradle
          cat > app/build.gradle << 'EOF'
          plugins {
              id 'com.android.application'
              id 'org.jetbrains.kotlin.android'
          }
          
          android {
              namespace '${{ github.event.inputs.package_name }}'
              compileSdk 34
              
              defaultConfig {
                  applicationId "${{ github.event.inputs.package_name }}"
                  minSdk 24
                  targetSdk 34
                  versionCode 1
                  versionName "1.0"
              }
              
              buildTypes {
                  release {
                      minifyEnabled false
                      proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
                  }
              }
              
              compileOptions {
                  sourceCompatibility JavaVersion.VERSION_17
                  targetCompatibility JavaVersion.VERSION_17
              }
              
              kotlinOptions {
                  jvmTarget = '17'
              }
          }
          
          dependencies {
              implementation 'androidx.core:core-ktx:1.12.0'
              implementation 'androidx.appcompat:appcompat:1.6.1'
              implementation 'com.google.android.material:material:1.11.0'
              implementation 'androidx.constraintlayout:constraintlayout:2.1.4'
          }
          EOF
          
          # AndroidManifest.xml
          cat > app/src/main/AndroidManifest.xml << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <manifest xmlns:android="http://schemas.android.com/apk/res/android"
              package="${{ github.event.inputs.package_name }}">
              
              <application
                  android:allowBackup="true"
                  android:icon="@drawable/ic_launcher"
                  android:label="${{ github.event.inputs.app_name }}"
                  android:theme="@style/Theme.MyApp">
                  
                  <activity
                      android:name=".MainActivity"
                      android:exported="true">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN" />
                          <category android:name="android.intent.category.LAUNCHER" />
                      </intent-filter>
                  </activity>
              </application>
          </manifest>
          EOF
          
          # MainActivity.kt
          MAIN_ACTIVITY_PATH="app/src/main/java/$(echo '${{ github.event.inputs.package_name }}' | sed 's/\./\//g')/MainActivity.kt"
          cat > "$MAIN_ACTIVITY_PATH" << 'EOF'
          package ${{ github.event.inputs.package_name }}
          
          import android.os.Bundle
          import androidx.appcompat.app.AppCompatActivity
          import android.widget.TextView
          
          class MainActivity : AppCompatActivity() {
              override fun onCreate(savedInstanceState: Bundle?) {
                  super.onCreate(savedInstanceState)
                  
                  val textView = TextView(this)
                  textView.text = "Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ ${{ github.event.inputs.app_name }}"
                  textView.textSize = 24f
                  
                  setContentView(textView)
              }
          }
          EOF
          
          # themes.xml
          cat > app/src/main/res/values/themes.xml << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <resources xmlns:tools="http://schemas.android.com/tools">
              <style name="Theme.MyApp" parent="Theme.MaterialComponents.DayNight.DarkActionBar">
                  <item name="colorPrimary">@color/purple_500</item>
                  <item name="colorPrimaryVariant">@color/purple_700</item>
                  <item name="colorOnPrimary">@color/white</item>
                  <item name="colorSecondary">@color/teal_200</item>
                  <item name="colorSecondaryVariant">@color/teal_700</item>
                  <item name="colorOnSecondary">@color/black</item>
              </style>
          </resources>
          EOF
          
          # colors.xml
          cat > app/src/main/res/values/colors.xml << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <resources>
              <color name="purple_200">#FFBB86FC</color>
              <color name="purple_500">#FF6200EE</color>
              <color name="purple_700">#FF3700B3</color>
              <color name="teal_200">#FF03DAC5</color>
              <color name="teal_700">#FF018786</color>
              <color name="black">#FF000000</color>
              <color name="white">#FFFFFFFF</color>
          </resources>
          EOF
          
          # strings.xml
          cat > app/src/main/res/values/strings.xml << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <resources>
              <string name="app_name">${{ github.event.inputs.app_name }}</string>
          </resources>
          EOF
          
          echo "âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ"
      
      - name: ğŸ”§ Ø¨Ù†Ø§Ø¡ APK
        run: |
          echo "ğŸ—ï¸ Ø¬Ø§Ø±ÙŠ Ø¨Ù†Ø§Ø¡ APK..."
          
          # Ø¥Ù†Ø´Ø§Ø¡ gradle wrapper
          if [ ! -f "gradlew" ]; then
              gradle wrapper --gradle-version 8.5
              chmod +x gradlew
          fi
          
          # Ø§Ù„Ø¨Ù†Ø§Ø¡
          ./gradlew assembleDebug --stacktrace --info
          
          if [ -f "app/build/outputs/apk/debug/app-debug.apk" ]; then
              echo "âœ… ØªÙ… Ø¨Ù†Ø§Ø¡ APK Ø¨Ù†Ø¬Ø§Ø­"
              ls -la app/build/outputs/apk/debug/
          else
              echo "âš ï¸ Ù„Ù… ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ APK"
              ls -la app/build/outputs/ || true
          fi
      
      - name: ğŸ“¦ Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª
        uses: actions/upload-artifact@v4
        with:
          name: android-app-build
          path: |
            app/build/outputs/apk/
            app/build/outputs/bundle/
            ai_response.txt
            app/src/main/
          retention-days: 7
      
      - name: ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†ØªØ§Ø¦Ø¬
        if: always()
        run: |
          echo "========================================"
          echo "ğŸ—ï¸ Ultimate Forge - Ø§ÙƒØªÙ…Ù„ Ø§Ù„Ø¨Ù†Ø§Ø¡"
          echo "========================================"
          echo "ğŸ“± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚: ${{ github.event.inputs.app_name }}"
          echo "ğŸ“¦ Ø§Ù„Ø­Ø²Ù…Ø©: ${{ github.event.inputs.package_name }}"
          echo "ğŸ’¡ Ø§Ù„ÙÙƒØ±Ø©: ${{ github.event.inputs.app_idea }}"
          echo "ğŸ¯ Ø§Ù„Ù†ØªÙŠØ¬Ø©: ${{ job.status }}"
          echo "========================================"
