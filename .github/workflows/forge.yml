name: The Forge Final v50

on:
  workflow_dispatch:
    inputs:
      idea:
        description: 'App Idea'
        required: true
        default: 'Simple App'

permissions:
  contents: write
  actions: write

jobs:
  build_process:
    runs-on: ubuntu-latest
    steps:
      - name: Step 1: Checkout Repository
        uses: actions/checkout@v4

      - name: Step 2: Java Setup
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Step 3: AI Code Generation
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          USER_PROMPT: ${{ github.event.inputs.idea }}
        run: |
          pip3 install requests
          python3 - <<'EOF'
          import os, requests, re, json
          
          api_key = os.getenv('GEMINI_API_KEY')
          prompt = os.getenv('USER_PROMPT')
          
          url = f"https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key={api_key}"
          
          prompt_text = f"Create Android Java MainActivity.java with package com.the.forge. App idea: {prompt}. Use programmatic UI only. No XML."
          
          payload = {
              "contents": [{
                  "parts": [{
                      "text": prompt_text
                  }]
              }]
          }
          
          res = requests.post(url, json=payload)
          data = res.json()
          
          if 'candidates' in data and data['candidates']:
              code = data['candidates'][0]['content']['parts'][0]['text']
              clean_code = re.sub(r'```java|```', '', code).strip()
              
              os.makedirs("app/src/main/java/com/the/forge", exist_ok=True)
              with open("app/src/main/java/com/the/forge/MainActivity.java", "w") as f:
                  f.write(clean_code)
              
              print("Code generated successfully!")
          else:
              print(f"Error: {json.dumps(data)}")
              exit(1)
          EOF

      - name: Step 4: Create Project Structure
        run: |
          # إنشاء هيكل المجلدات
          mkdir -p app/src/main/res/values
          mkdir -p app/src/main/res/drawable
          
          # 1. settings.gradle
          echo 'include ":app"' > settings.gradle
          
          # 2. build.gradle (root)
          cat << 'EOF' > build.gradle
          buildscript {
              repositories {
                  google()
                  mavenCentral()
              }
              dependencies {
                  classpath 'com.android.tools.build:gradle:8.2.0'
              }
          }
          
          allprojects {
              repositories {
                  google()
                  mavenCentral()
              }
          }
          
          task clean(type: Delete) {
              delete rootProject.buildDir
          }
          EOF
          
          # 3. app/build.gradle
          cat << 'EOF' > app/build.gradle
          plugins {
              id 'com.android.application'
          }
          
          android {
              namespace 'com.the.forge'
              compileSdk 34
              
              defaultConfig {
                  applicationId "com.the.forge"
                  minSdk 24
                  targetSdk 34
                  versionCode 1
                  versionName "1.0"
              }
              
              buildTypes {
                  release {
                      minifyEnabled false
                      proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
                  }
              }
              
              compileOptions {
                  sourceCompatibility JavaVersion.VERSION_17
                  targetCompatibility JavaVersion.VERSION_17
              }
          }
          
          dependencies {
              implementation 'androidx.appcompat:appcompat:1.6.1'
              implementation 'com.google.android.material:material:1.11.0'
              implementation 'androidx.constraintlayout:constraintlayout:2.1.4'
          }
          EOF
          
          # 4. AndroidManifest.xml
          cat << 'EOF' > app/src/main/AndroidManifest.xml
          <?xml version="1.0" encoding="utf-8"?>
          <manifest xmlns:android="http://schemas.android.com/apk/res/android"
              package="com.the.forge">
              
              <application
                  android:allowBackup="true"
                  android:icon="@drawable/ic_launcher"
                  android:label="The Forge App"
                  android:theme="@style/Theme.MaterialComponents.DayNight">
                  
                  <activity
                      android:name=".MainActivity"
                      android:exported="true"
                      android:label="The Forge">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN" />
                          <category android:name="android.intent.category.LAUNCHER" />
                      </intent-filter>
                  </activity>
              </application>
          </manifest>
          EOF
          
          # 5. themes.xml
          cat << 'EOF' > app/src/main/res/values/themes.xml
          <?xml version="1.0" encoding="utf-8"?>
          <resources xmlns:tools="http://schemas.android.com/tools">
              <style name="Theme.TheForge" parent="Theme.MaterialComponents.DayNight.DarkActionBar">
                  <item name="colorPrimary">#FF6200EE</item>
                  <item name="colorPrimaryVariant">#FF3700B3</item>
                  <item name="colorOnPrimary">#FFFFFFFF</item>
                  <item name="colorSecondary">#FF03DAC5</item>
                  <item name="colorSecondaryVariant">#FF018786</item>
                  <item name="colorOnSecondary">#FF000000</item>
              </style>
          </resources>
          EOF
          
          # 6. colors.xml
          cat << 'EOF' > app/src/main/res/values/colors.xml
          <?xml version="1.0" encoding="utf-8"?>
          <resources>
              <color name="purple_200">#FFBB86FC</color>
              <color name="purple_500">#FF6200EE</color>
              <color name="purple_700">#FF3700B3</color>
              <color name="teal_200">#FF03DAC5</color>
              <color name="teal_700">#FF018786</color>
              <color name="black">#FF000000</color>
              <color name="white">#FFFFFFFF</color>
          </resources>
          EOF
          
          # 7. إنشاء أيقونة افتراضية بسيطة
          echo "iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAABCSURBVDhP7Y3BCYAwEESFkA52Yg0W4FHsJGrCYz1WoCIlCKEI8/MW5j5gVs7yQSl0t7k4fCQweR+bOcJPHnMgr/gL8QOag2jSge6i2QAAAABJRU5ErkJggg==" | base64 -d > app/src/main/res/drawable/ic_launcher.png

      - name: Step 5: Build APK
        run: |
          ./gradlew assembleDebug
          
      - name: Step 6: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: Forge-APK
          path: app/build/outputs/apk/debug/*.apk
          retention-days: 7
